<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>My Intel</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #0A84FF; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 80px;}
        
        h1 { font-size: 24px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .section-title { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-top: 30px; margin-bottom: 10px; }

        /* Card Style */
        .card { background: var(--card); border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.1s; }
        .card:active { transform: scale(0.98); }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .card-content { padding: 15px; }
        .source-tag { font-size: 10px; background: #333; padding: 4px 8px; border-radius: 4px; color: #aaa; text-transform: uppercase; }
        .medical-tag { background: #2d5a2d; color: #aaffaa; } 
        h2 { font-size: 18px; margin: 10px 0; line-height: 1.3; }
        p { font-size: 14px; color: #aaa; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* Directives Input */
        .controls { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        button { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: 600; white-space: nowrap; }
        button.active { background: var(--accent); }
    </style>
</head>
<body>

<button onclick="subscribe()" style="background:red; width:100%; margin-bottom:20px;">ENABLE ALERTS</button>

    <h1>Daily Briefing</h1>

    <div class="controls">
        <button onclick="loadNews('AI')">Tech: AI</button>
        <button onclick="loadNews('Space')">Tech: Space</button>
        <button onclick="loadNews('Politics')">World</button>
        <button onclick="loadMedical('Immunotherapy')">Med: Immunotherapy</button>
        <button onclick="loadMedical('Neurology')">Med: Neurology</button>
    </div>

    <div id="feed">
        <p style="text-align:center; margin-top:50px; color:#555;">Select a category above...</p>
    </div>

    <script>
        async function loadNews(keyword) {
            document.getElementById('feed').innerHTML = '<p style="text-align:center; padding:20px;">Scouring sources...</p>';
            
            const response = await fetch(`/api/news?category=${keyword}`);
            const data = await response.json();
            renderCards(data);
        }

        async function loadMedical(keyword) {
            document.getElementById('feed').innerHTML = '<p style="text-align:center; padding:20px;">Accessing NLM Database...</p>';
            
            const response = await fetch(`/api/medical?keyword=${keyword}`);
            const data = await response.json();
            renderCards(data);
        }

        function renderCards(articles) {
            const container = document.getElementById('feed');
            container.innerHTML = '';

            if(articles.length === 0) {
                container.innerHTML = '<p>No recent free articles found.</p>';
                return;
            }

            articles.forEach(art => {
                const isMedical = art.isMedical;
                // Use a generic DNA image for medical papers if no image exists
                const imageHtml = isMedical 
                    ? `<div style="height:100px; background:#1e3a1e; display:flex; align-items:center; justify-content:center; color:#4caf50; font-weight:bold; letter-spacing:2px;">NLM RESEARCH</div>`
                    : `<img src="${art.urlToImage}" alt="News Image">`;

                const tagClass = isMedical ? 'source-tag medical-tag' : 'source-tag';

                const html = `
                <div class="card" onclick="window.open('${art.url}', '_blank')">
                    ${imageHtml}
                    <div class="card-content">
                        <span class="${tagClass}">${art.source.name || art.source}</span>
                        <h2>${art.title}</h2>
                        ${art.description ? `<p>${art.description}</p>` : ''}
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        // Load default on start
        loadNews('Artificial Intelligence');
    </script>
<script>
    // Register the Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(err => console.error(err));
    }

    // The Magic Function to Ask Permission
    async function subscribe() {
        console.log("Registering for push...");
        const register = await navigator.serviceWorker.register('/sw.js', {
            scope: '/'
        });

        console.log("Asking for permission...");
        // This MUST match the Public Key in server.js
        const publicVapidKey = 'BCQ227xykhxU4uQAb0EIEnrMMEzqGL6aUW925qfdLArQFSNxnqf6fn4lSl98xzb0vKHSSwJcgfkkfyRF0BTHhs0'; 

        const subscription = await register.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
        });

        console.log("Sending subscription to server...");
        await fetch('/subscribe', {
            method: 'POST',
            body: JSON.stringify(subscription),
            headers: {
                'content-type': 'application/json'
            }
        });
        alert("Notifications Enabled!");
    }

    // Helper function to convert key
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }
</script>
</body>
</html>